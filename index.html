<!DOCTYPE html>
<html lang="fr">
<head> 
  <meta charset="UTF-8" />
  <title>Prix électricité — Sans ARENH</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    html, body { margin:0; overflow:hidden; } /* pas de scroll interne */
    body {
      background:#f9fafb; 
      font-family:'Inter', system-ui, -apple-system, Segoe UI, sans-serif;
      display:flex; justify-content:center;
    }
    .chart-wrapper{
      background:#fff;
      border-radius:16px;
      box-shadow:0 8px 24px rgba(0,0,0,.06);
      padding:8px 16px 12px;    /* top réduit pour coller le graphe */
      width:100%; max-width:940px;
      margin:0 auto;            /* plus d’espace au-dessus */
    }
    h1{
      margin:0 0 6px;           /* marge basse minimale */
      text-align:center;
      font-size:22px; font-weight:600; color:#0b0f19;
    }
    /* Le JS fige la taille réelle du canvas (pas de reflow) */
    #myChart{ display:block; width:100%; height:auto; }
  </style>
</head>
<body>
  <div class="chart-wrapper" id="wrap">
    <h1>Prédiction du prix du kwh au TRVE en 2026</h1>
    <canvas id="myChart" aria-label="Courbe Sans ARENH" role="img"></canvas>
  </div>

  <script>
    const jsonUrl = "https://raw.githubusercontent.com/FEPPN/Graph/main/data.json";

    const pick = (o, ks) => { for (const k of ks) if (o?.[k] !== undefined && o[k] !== null && o[k] !== "") return o[k]; };
    const fmtDate = iso => {
      try { return new Date(iso).toLocaleDateString('fr-FR', { day:'2-digit', month:'2-digit', year:'numeric' }); }
      catch { return String(iso ?? ""); }
    };

    let chart;

    // Taille "safe": on fige le canvas (pas de responsive Chart.js)
    function sizeCanvasOnce(){
      const wrap   = document.getElementById('wrap');
      const canvas = document.getElementById('myChart');

      // largeur = largeur interne du wrapper
      const w = Math.floor(wrap.clientWidth);
      // hauteur confortable sous 560px d'iframe
      const h = 480;

      // Définir les ATTRIBUTS width/height du canvas (clé)
      canvas.setAttribute('width', String(w));
      canvas.setAttribute('height', String(h));
      return canvas.getContext('2d');
    }

    fetch(jsonUrl, { cache: "no-store" })
      .then(r => { if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); })
      .then(rows => {
        const isoDates = [], labels = [], values = [];
        rows.forEach(r => {
          const iso = pick(r, ["Date","date","dateISO"]);
          const wo  = Number(pick(r, ["withoutARENH","without_arenh","woARENH"]));
          if (!iso || Number.isNaN(wo)) return;
          isoDates.push(String(iso));
          labels.push(fmtDate(iso));
          values.push(wo);
        });

        // Axe Y serré (pas d’écrasement)
        const yMin = Math.min(...values);
        const yMax = Math.max(...values);
        const pad  = Math.max((yMax - yMin) * 0.06, 0.0005);

        const ctx = sizeCanvasOnce();  // fige la taille
        const canvas = ctx.canvas;

        // Dégradé violet Papernest sous la courbe (léger)
        const g = ctx.createLinearGradient(0, 0, 0, canvas.height);
        g.addColorStop(0, "rgba(90, 82, 255, 0.22)");  // #5a52ff 22%
        g.addColorStop(1, "rgba(90, 82, 255, 0.00)");

        if (chart) chart.destroy();

        chart = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [{
              label: "Sans ARENH",
              data: values,
              borderColor: "#5a52ff",   // violet Papernest
              backgroundColor: g,       // dégradé
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.28,
              fill: true                 // active le dégradé
            }]
          },
          options: {
            // Désactivé = pas de “danse” au scroll
            responsive: false,
            animation: false,
            layout: { padding: 0 }, // colle le graphe
            interaction: { mode: 'nearest', intersect: false },
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: "#fff",
                borderColor: "#e5e7eb", borderWidth: 1,
                titleColor: "#111827", bodyColor: "#4b5563",
                titleFont: { weight:'700' }, bodyFont: { weight:'500' },
                padding: 10, cornerRadius: 10,
                callbacks: { label: (c) => `${c.parsed.y.toFixed(4)} € / kWh` }
              }
            },
            scales: {
              y: {
                min: yMin - pad,
                max: yMax + pad,
                beginAtZero: false,
                ticks: {
                  color: "#6b7280",
                  callback: v => `${Number(v).toFixed(3)} €`
                },
                grid: { color: "rgba(0,0,0,0.06)" },
                border: { display:false }
              },
              x: {
                ticks: {
                  color: "#6b7280",
                  maxRotation: 0,
                  autoSkip: true,
                  maxTicksLimit: 8,
                  callback: (val, idx) => fmtDate(isoDates[idx] ?? labels[idx])
                },
                grid: { display: false },
                border: { display:false }
              }
            }
          }
        });
      })
      .catch(err => {
        console.error("Erreur chargement JSON:", err);
        document.getElementById('wrap').insertAdjacentHTML(
          "beforeend",
          `<p style="margin-top:12px;color:#ef4444;text-align:center">Erreur de chargement des données.</p>`
        );
      });
  </script>
</body>
</html>




